name: Publish to Maven Central

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for JReleaser

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

      - name: Build plugin
        run: ./gradlew build

      - name: Stage artifacts for JReleaser
        run: ./gradlew publishAllPublicationsToStagingDeployRepository
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Decode GPG keys
        run: |
          # Decode and strip any leading whitespace from each line
          echo "${{ secrets.GPG_PUBLIC_KEY_BASE64 }}" | base64 -d | sed 's/^[[:space:]]*//' > /tmp/gpg-public.asc
          echo "${{ secrets.GPG_PRIVATE_KEY_BASE64 }}" | base64 -d | sed 's/^[[:space:]]*//' > /tmp/gpg-private.asc
          echo "=== GPG Public Key ==="
          cat /tmp/gpg-public.asc
          echo "=== Key length: $(wc -c < /tmp/gpg-public.asc) bytes ==="
          echo "JRELEASER_GPG_PUBLIC_KEY<<EOF" >> $GITHUB_ENV
          cat /tmp/gpg-public.asc >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "JRELEASER_GPG_SECRET_KEY<<EOF" >> $GITHUB_ENV
          cat /tmp/gpg-private.asc >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Deploy to Maven Central (via JReleaser Gradle plugin)
        run: ./gradlew jreleaserDeploy
        env:
          JRELEASER_PROJECT_VERSION: ${{ github.event.release.tag_name || github.ref_name }}
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JRELEASER_MAVENCENTRAL_SONATYPE_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          JRELEASER_MAVENCENTRAL_SONATYPE_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          JRELEASER_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: JReleaser output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jreleaser-release
          path: |
            build/jreleaser/trace.log
            build/jreleaser/output.properties
